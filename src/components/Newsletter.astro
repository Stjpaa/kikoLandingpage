---
// src/components/Newsletter.astro
---

<section id="join" class="py-24 px-6 text-center">
    <div class="max-w-2xl mx-auto bg-cup-yellow p-10 rounded-[3rem] shadow-2xl border-4 border-white -rotate-1">
        <h2 class="text-4xl font-black mb-4 text-gray-900">Trete der Kiko-Community bei!</h2>
        <p class="text-lg mb-8 text-gray-800">Wir starten bald. Melde dich an und erhalte regelm√§√üig Updates!</p>

        <form id="kiko-newsletter" class="flex flex-col gap-5">
            <div class="flex flex-col text-left gap-1">
                <label for="name-field" class="ml-2 text-sm font-bold text-gray-700">Dein Vorname</label>
                <input
                        id="name-field"
                        name="first_name"
                        type="text"
                        required
                        placeholder="z.B. Mario"
                        class="p-5 rounded-2xl border-2 border-gray-100 bg-white focus:ring-4 focus:ring-cup-red focus:border-cup-red text-lg shadow-sm outline-none transition-all placeholder:text-gray-400"
                />
            </div>

            <div class="flex flex-col text-left gap-1">
                <label for="email-field" class="ml-2 text-sm font-bold text-gray-700">Deine E-Mail</label>
                <input
                        id="email-field"
                        name="email"
                        type="email"
                        required
                        placeholder="mario@luigi.de"
                        class="p-5 rounded-2xl border-2 border-gray-100 bg-white focus:ring-4 focus:ring-cup-red focus:border-cup-red text-lg shadow-sm outline-none transition-all placeholder:text-gray-400"
                />
            </div>

            <button id="submit-btn" class="mt-2 p-5 bg-cup-red text-white text-xl font-black rounded-2xl hover:bg-red-600 hover:scale-[1.02] active:scale-[0.98] transition-all shadow-xl disabled:opacity-50 disabled:cursor-not-allowed">
                Lass uns kochen! üçù
            </button>
        </form>

        <div id="response-container" class="mt-6 min-h-[24px]">
            <p id="response-msg" class="text-sm font-bold hidden px-4 py-2 rounded-lg"></p>
        </div>
        <p class="mt-2 text-sm text-gray-700 opacity-80 italic">Kein Spam, nur leckere Inspirationen.</p>
    </div>
</section>

<script>
    import { supabase } from '../lib/supabase';

    const form = document.getElementById('kiko-newsletter') as HTMLFormElement;
    const btn = document.getElementById('submit-btn') as HTMLButtonElement;
    const msg = document.getElementById('response-msg');

    form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        btn.disabled = true;
        const originalBtnText = btn.innerHTML;
        btn.innerText = "Wird gesendet...";
        msg?.classList.add('hidden');

        const formData = new FormData(form);
        const email = formData.get('email');
        const first_name = formData.get('first_name');

        const { error } = await supabase
            .from('subscribers')
            .insert([{ email, first_name }]);

        if (error) {
            msg!.innerText = "Hoppla! Das hat nicht geklappt.";
            msg!.className = "text-sm font-bold px-4 py-2 rounded-lg bg-red-100 text-red-700";
            msg!.classList.remove('hidden');
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        } else {
            msg!.innerText = `Willkommen im Team, ${first_name}! üçù`;
            msg!.className = "text-sm font-bold px-4 py-2 rounded-lg bg-green-100 text-green-700";
            msg!.classList.remove('hidden');
            form.reset();
            btn.innerText = "Check!";
        }
    });
</script>